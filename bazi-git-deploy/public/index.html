<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—æ’ç›˜è®¡ç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }

        .btn-reset:hover {
            background: #e0e0e0;
        }

        .btn-copy {
            background: #27ae60;
            color: white;
            margin-top: 10px;
        }

        .btn-copy:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-copy.copied {
            background: #3498db;
        }

        .btn-fortune {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-fortune:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
        }

        .btn-fortune:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            display: none;
        }

        .result.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .fortune-chart-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .fortune-chart-container.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .fortune-chart-title {
            text-align: center;
            color: #333;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #fortuneChart {
            width: 100%;
            height: 600px;
            min-height: 600px;
        }

        .fortune-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.8;
        }

        .fortune-legend h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .fortune-legend p {
            color: #666;
            margin: 5px 0;
        }

        .fortune-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .fortune-controls label {
            color: #555;
            font-size: 14px;
            margin-bottom: 0;
        }

        .fortune-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .result-label {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .result-value {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            padding: 12px;
            background: #fadbd8;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 600px) {
            .form-group {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ å…«å­—æ’ç›˜è®¡ç®—å™¨</h1>
        <p class="subtitle">è¾“å…¥æ‚¨çš„å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´ï¼Œè·å–è¯¦ç»†çš„å…«å­—ä¿¡æ¯</p>

        <form id="baziForm">
            <div class="form-group">
                <div>
                    <label for="year">å‡ºç”Ÿå¹´ä»½</label>
                    <input type="number" id="year" name="year" min="1900" max="2100" value="2000" required>
                </div>
                <div>
                    <label for="month">å‡ºç”Ÿæœˆä»½</label>
                    <input type="number" id="month" name="month" min="1" max="12" value="1" required>
                </div>
            </div>

            <div class="form-group">
                <div>
                    <label for="day">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="number" id="day" name="day" min="1" max="31" value="1" required>
                </div>
                <div>
                    <label for="hour">å‡ºç”Ÿå°æ—¶</label>
                    <input type="number" id="hour" name="hour" min="0" max="23" value="12" required>
                </div>
            </div>

            <div class="form-group">
                <div>
                    <label for="minute">å‡ºç”Ÿåˆ†é’Ÿ</label>
                    <input type="number" id="minute" name="minute" min="0" max="59" value="30" required>
                </div>
                <div>
                    <label for="second">å‡ºç”Ÿç§’æ•°</label>
                    <input type="number" id="second" name="second" min="0" max="59" value="0" required>
                </div>
            </div>

            <div class="form-group">
                <div>
                    <label for="sex">æ€§åˆ«</label>
                    <select id="sex" name="sex" required>
                        <option value="0">å¥³</option>
                        <option value="1">ç”·</option>
                    </select>
                </div>
                <div>
                    <label for="birthplace">å‡ºç”Ÿåœ°</label>
                    <input type="text" id="birthplace" name="birthplace" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚" required>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn-calculate">è®¡ç®—å…«å­—</button>
                <button type="reset" class="btn-reset">é‡ç½®</button>
            </div>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #999;">æ­£åœ¨è®¡ç®—ä¸­...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <div class="result-item">
                <div class="result-label">æ€§åˆ«</div>
                <div class="result-value" id="sexDisplay"></div>
            </div>
            <div class="result-item">
                <div class="result-label">å‡ºç”Ÿåœ°</div>
                <div class="result-value" id="birthplaceDisplay"></div>
            </div>
            <div class="result-item">
                <div class="result-label">å…¬å†æ—¥æœŸ</div>
                <div class="result-value" id="solarDate"></div>
            </div>
            <div class="result-item">
                <div class="result-label">å†œå†æ—¥æœŸ</div>
                <div class="result-value" id="lunarDate"></div>
            </div>
            <div class="result-item">
                <div class="result-label">å››æŸ±å…«å­—</div>
                <div class="result-value" id="siZhu"></div>
            </div>
            <div class="result-item">
                <div class="result-label">å¤§è¿</div>
                <div class="result-value" id="daYun"></div>
            </div>
            <div class="result-item">
                <div class="result-label">èµ·è¿æ—¶é—´</div>
                <div class="result-value" id="qiYunDate"></div>
            </div>
            <button type="button" class="btn-copy" id="copyBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
            <button type="button" class="btn-fortune" id="fortuneBtn">ğŸ“ˆ æŸ¥çœ‹ç™¾å¹´è¿åŠ¿Kçº¿å›¾</button>
        </div>

        <div class="fortune-chart-container" id="fortuneChartContainer">
            <h2 class="fortune-chart-title">ğŸ“Š ç™¾å¹´è¿åŠ¿Kçº¿å›¾</h2>
            <div class="fortune-controls">
                <label for="chartRange">æ˜¾ç¤ºèŒƒå›´:</label>
                <select id="chartRange">
                    <option value="20">å‰20å¹´</option>
                    <option value="30">å‰30å¹´</option>
                    <option value="50">å‰50å¹´</option>
                    <option value="100" selected>å…¨éƒ¨100å¹´</option>
                </select>
<button type="button" class="btn-reset" id="refreshChart">åˆ·æ–°å›¾è¡¨</button>
            </div>
            <div id="fortuneChart"></div>
            <div class="fortune-legend">
                <h4>ğŸ“– Kçº¿å›¾è¯´æ˜</h4>
                <p><strong>çº¢è‰²Kçº¿(é˜³çº¿):</strong> å¹´æœ«è¿åŠ¿ > å¹´åˆè¿åŠ¿,æ•´ä½“è¿åŠ¿ä¸Šæ‰¬</p>
                <p><strong>ç»¿è‰²Kçº¿(é˜´çº¿):</strong> å¹´æœ«è¿åŠ¿ < å¹´åˆè¿åŠ¿,æ•´ä½“è¿åŠ¿ä¸‹é™</p>
                <p><strong>ä¸Šå½±çº¿:</strong> è¯¥å¹´å¯è¾¾åˆ°çš„æœ€é«˜è¿åŠ¿</p>
                <p><strong>ä¸‹å½±çº¿:</strong> è¯¥å¹´å¯èƒ½é‡åˆ°çš„æœ€ä½è¿åŠ¿</p>
                <p><strong>ç´«è‰²æ›²çº¿:</strong> ç»¼åˆè¯„åˆ†è¶‹åŠ¿çº¿,åæ˜ æ•´ä½“è¿åŠ¿èµ°å‘</p>
                <p><strong>ç°è‰²è™šçº¿:</strong> å¹³å‡çº¿(50åˆ†),é«˜äºå¹³å‡çº¿ä¸ºé¡º,ä½äºå¹³å‡çº¿ä¸ºé€†</p>
                
                <h4 style="margin-top: 20px;">ğŸ”® è¿åŠ¿è®¡ç®—ç®—æ³•è¯¦è§£</h4>
                
                <div style="background: #fff; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #667eea;">
                    <p style="font-weight: 600; color: #667eea; margin-bottom: 10px;">ç®—æ³•æƒé‡åˆ†é…ï¼ˆæ€»è®¡100%ï¼‰ï¼š</p>
                    
                    <p style="margin: 5px 0;"><strong>1. å¤§è¿å½±å“ (35%)</strong></p>
                    <p style="margin-left: 20px; font-size: 13px; color: #666;">
                        â€¢ å¤§è¿å¤©å¹²å¯¹æ—¥ä¸»ç”Ÿå…‹ (25%) - åå¹´å¤§è¿ä¸»å¯¼æ•´ä½“èµ°åŠ¿<br>
                        â€¢ å¤§è¿åœ°æ”¯å¯¹æ—¥ä¸»ç”Ÿå…‹ (20%) - åœ°æ”¯åŠ›é‡æŒä¹…æ·±è¿œ<br>
                        â€¢ æœªèµ·è¿æœŸå½±å“å‡åŠ
                    </p>
                    
                    <p style="margin: 5px 0;"><strong>2. æµå¹´å½±å“ (25%)</strong></p>
                    <p style="margin-left: 20px; font-size: 13px; color: #666;">
                        â€¢ æµå¹´å¤©å¹²å¯¹æ—¥ä¸»ç”Ÿå…‹ (15%) - å½“å¹´å¤ªå²ä¸»äº‹<br>
                        â€¢ æµå¹´åœ°æ”¯å¯¹æ—¥ä¸»ç”Ÿå…‹ (12%) - å½“å¹´åœ°æ°”å½±å“<br>
                        â€¢ æµå¹´å†³å®šè¯¥å¹´å…·ä½“å‰å‡¶
                    </p>
                    
                    <p style="margin: 5px 0;"><strong>3. å¤§è¿æµå¹´äº’åŠ¨ (12%)</strong></p>
                    <p style="margin-left: 20px; font-size: 13px; color: #666;">
                        â€¢ å¤©å¹²ç›¸åˆ(å¦‚ç”²å·±åˆ): +7åˆ† å‰<br>
                        â€¢ åœ°æ”¯ç›¸åˆ(å¦‚å­ä¸‘åˆ): +5åˆ† å‰<br>
                        â€¢ å¤©å¹²ç›¸å†²(é˜´é˜³åŒæ€§å…‹): -7åˆ† å‡¶<br>
                        â€¢ åœ°æ”¯ç›¸å†²(å¦‚å­åˆå†²): -9åˆ† å¤§å‡¶
                    </p>
                    
                    <p style="margin: 5px 0;"><strong>4. ç¥ç…å½±å“ (20%)</strong></p>
                    <p style="margin-left: 20px; font-size: 13px; color: #666;">
                        â€¢ å¤§è¿ç¥ç… (10%): å¤©ä¹™è´µäºº+12ã€æ–‡æ˜Œ+8ã€ç¾Šåˆƒ-8ç­‰<br>
                        â€¢ æµå¹´ç¥ç… (10%): ç¦„ç¥+8ã€åŠ«ç…-7ã€æ¡ƒèŠ±+3ç­‰<br>
                        â€¢ å‰ç¥åˆ¶å‡¶ã€è´µäººåŒ–é™©ä¸ºå¤·
                    </p>
                    
                    <p style="margin: 5px 0;"><strong>5. å…¶ä»–å› ç´  (8%)</strong></p>
                    <p style="margin-left: 20px; font-size: 13px; color: #666;">
                        â€¢ æµå¹´ä¸æ—¥æŸ±å…³ç³» (8%): å†²æ—¥æ”¯-6ã€åˆæ—¥æ”¯+4<br>
                        â€¢ äº”è¡Œå¹³è¡¡åº¦ (5%): è¡¥å¼±äº”è¡Œä¸ºå‰ã€è¿‡æ—ºä¸ºå‡¶<br>
                        â€¢ å¹´é¾„ç”Ÿå‘½å‘¨æœŸ (3%): 30-40å²é«˜å³°æœŸ+10<br>
                        â€¢ æ¢å¤§è¿äº¤æ¥æœŸ (ç‰¹æ®Š): è¿åŠ¿æ³¢åŠ¨-4
                    </p>
                </div>
                
                <div style="background: #fffaf0; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #ff9800;">
                    <p style="font-weight: 600; color: #ff9800; margin-bottom: 10px;">ğŸ“Š äº”è¡Œç”Ÿå…‹è¯„åˆ†è§„åˆ™ï¼š</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ è¢«ç”Ÿï¼ˆå—ç”Ÿæ‰¶ï¼‰: <span style="color: #2ed573;">+12åˆ† â˜…â˜…â˜…</span> å¦‚æ°´å‘½é‡é‡‘å¹´(é‡‘ç”Ÿæ°´)</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ å…‹ä»–äººï¼ˆæˆ‘å…‹è´¢ï¼‰: <span style="color: #2ed573;">+8åˆ† â˜…â˜…</span> å¦‚æ°´å‘½é‡ç«å¹´(æ°´å…‹ç«å¾—è´¢)</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ åŒç±»æ¯”å’Œ: <span style="color: #ffd93d;">+6åˆ† â˜…</span> å¦‚æ°´å‘½é‡æ°´å¹´(å¸®èº«)</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ ç”Ÿä»–äººï¼ˆæ³„æ°”ï¼‰: <span style="color: #ffa502;">+5åˆ†</span> å¦‚æ°´å‘½é‡æœ¨å¹´(æ°´ç”Ÿæœ¨æ³„èº«)</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ è¢«å…‹ï¼ˆå—å®˜æ€å…‹ï¼‰: <span style="color: #ff4757;">-10åˆ† âœ—âœ—âœ—</span> å¦‚æ°´å‘½é‡åœŸå¹´(åœŸå…‹æ°´)</p>
                </div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #3498db;">
                    <p style="font-weight: 600; color: #3498db; margin-bottom: 10px;">ğŸ’¡ è¿åŠ¿ç­‰çº§åˆ’åˆ†ï¼š</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ 70åˆ†ä»¥ä¸Š: <strong style="color: #2ed573;">å¤§å‰</strong> - è´µäººç›¸åŠ©,è¯¸äº‹é¡ºé‚</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ 60-70åˆ†: <strong style="color: #7bed9f;">è¾ƒå‰</strong> - è¿åŠ¿ä¸Šå‡,åˆ©äºå‘å±•</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ 50-60åˆ†: <strong style="color: #ffd93d;">å¹³ç¨³</strong> - å¹³å¹³ç¨³ç¨³,æ— å¤§èµ·å¤§è½</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ 40-50åˆ†: <strong style="color: #ff6348;">è¾ƒå·®</strong> - å¤šæœ‰æ³¢æŠ˜,éœ€è°¨æ…è¡Œäº‹</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ 40åˆ†ä»¥ä¸‹: <strong style="color: #ff4757;">ä½è°·</strong> - è¿åŠ¿ä½è¿·,å®œå®ˆä¸å®œæ”»</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #95a5a6;">
                    <p style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">ğŸ¯ å®æˆ˜åº”ç”¨å»ºè®®ï¼š</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ è¿åŠ¿é«˜å³°æœŸ(70+): é€‚åˆåˆ›ä¸šã€æŠ•èµ„ã€æ±‚èŒã€è€ƒè¯•ã€å©šå«ç­‰é‡å¤§äº‹é¡¹</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ è¿åŠ¿å¹³ç¨³æœŸ(50-70): é€‚åˆç¨³æ­¥å‘å±•ã€å­¦ä¹ å……ç”µã€ç»´æŠ¤å…³ç³»</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ è¿åŠ¿ä½è°·æœŸ(40-): å®œå®ˆä¸å®œæ”»ã€éŸ¬å…‰å…»æ™¦ã€ç­‰å¾…æ—¶æœº</p>
                    <p style="margin: 3px 0; font-size: 13px;">â€¢ æ¢å¤§è¿ä¹‹å¹´: è¿åŠ¿æ³¢åŠ¨å¤§,è°¨æ…å†³ç­–,ä»¥ä¸å˜åº”ä¸‡å˜</p>
                </div>
                
                <p style="color: #e74c3c; margin-top: 15px; font-weight: 600; font-size: 14px;">
                    <strong>âš ï¸ é‡è¦æé†’:</strong> 
                    æ­¤è¿åŠ¿å›¾åŸºäºä¼ ç»Ÿå‘½ç†å­¦è®¡ç®—,ä»…ä¾›å‚è€ƒå¨±ä¹ã€‚äººçš„å‘½è¿å—å¤šç§å› ç´ å½±å“,åŒ…æ‹¬ä¸ªäººåŠªåŠ›ã€æ•™è‚²èƒŒæ™¯ã€ç¤¾ä¼šç¯å¢ƒã€æœºé‡é€‰æ‹©ç­‰ã€‚
                    è¿åŠ¿ä¸æ˜¯å®¿å‘½,ç§¯æè¿›å–æ‰æ˜¯æ”¹å˜å‘½è¿çš„æ ¹æœ¬ï¼
                </p>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('baziForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const result = document.getElementById('result');
        const copyBtn = document.getElementById('copyBtn');
        const fortuneBtn = document.getElementById('fortuneBtn');
        const fortuneChartContainer = document.getElementById('fortuneChartContainer');
        const chartRange = document.getElementById('chartRange');
        const refreshChart = document.getElementById('refreshChart');
        
        let currentResultData = null;
        let currentBaziRequest = null;
        let fortuneData = null;
        let fortuneChart = null;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const birthplace = document.getElementById('birthplace').value.trim();
            const sex = parseInt(document.getElementById('sex').value);
            
            const formData = {
                year: parseInt(document.getElementById('year').value),
                month: parseInt(document.getElementById('month').value),
                day: parseInt(document.getElementById('day').value),
                hour: parseInt(document.getElementById('hour').value),
                minute: parseInt(document.getElementById('minute').value),
                second: parseInt(document.getElementById('second').value),
                sex: sex,
            };

            // éªŒè¯æ—¥æœŸ
            if (formData.year < 1900 || formData.year > 2100) {
                showError('å¹´ä»½åº”åœ¨ 1900-2100 ä¹‹é—´');
                return;
            }

            if (formData.month < 1 || formData.month > 12) {
                showError('æœˆä»½åº”åœ¨ 1-12 ä¹‹é—´');
                return;
            }

            if (formData.day < 1 || formData.day > 31) {
                showError('æ—¥æœŸåº”åœ¨ 1-31 ä¹‹é—´');
                return;
            }

            if (!birthplace) {
                showError('è¯·è¾“å…¥å‡ºç”Ÿåœ°');
                return;
            }

            loading.classList.add('show');
            error.classList.remove('show');
            result.classList.remove('show');
            
            // ã€ä¿®å¤ã€‘é‡æ–°è®¡ç®—æ—¶éšè—è¿åŠ¿Kçº¿å›¾
            fortuneChartContainer.classList.remove('show');
            fortuneData = null; // æ¸…ç©ºè¿åŠ¿æ•°æ®
            if (fortuneChart) {
                fortuneChart.dispose();
                fortuneChart = null;
            }

            try {
                const response = await fetch('/api/bazi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();

                if (data.success) {
                    // ä¿å­˜å½“å‰ç»“æœæ•°æ®
                    currentResultData = {
                        sex: sex,
                        birthplace: birthplace,
                        ...data.data
                    };
                    
                    // ä¿å­˜å½“å‰è¯·æ±‚å‚æ•°ç”¨äºè¿åŠ¿è®¡ç®—
                    currentBaziRequest = formData;
                    
                    // æ˜¾ç¤ºæ€§åˆ«å’Œå‡ºç”Ÿåœ°
                    document.getElementById('sexDisplay').textContent = sex === 1 ? 'ç”·' : 'å¥³';
                    document.getElementById('birthplaceDisplay').textContent = birthplace;
                    
                    // æ˜¾ç¤ºå…¶ä»–ä¿¡æ¯
                    document.getElementById('solarDate').textContent = data.data.solarDate;
                    document.getElementById('lunarDate').textContent = data.data.lunarDate;
                    document.getElementById('siZhu').textContent = data.data.siZhu;
                    document.getElementById('daYun').textContent = data.data.daYun;
                    document.getElementById('qiYunDate').textContent = data.data.qiYunDate;

                    result.classList.add('show');
                    
                    // å¯ç”¨è¿åŠ¿æŒ‰é’®
                    fortuneBtn.disabled = false;
                } else {
                    showError(data.error || 'è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            } finally {
                loading.classList.remove('show');
            }
        });

        // å¤åˆ¶æŒ‰é’®åŠŸèƒ½
        copyBtn.addEventListener('click', async () => {
            if (!currentResultData) {
                showError('æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ');
                return;
            }

            // æ ¼å¼åŒ–ç»“æœæ–‡æœ¬
            const formattedText = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           å…«å­—æ’ç›˜ç»“æœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€åŸºæœ¬ä¿¡æ¯ã€‘
æ€§åˆ«ï¼š${currentResultData.sex === 1 ? 'ç”·' : 'å¥³'}
å‡ºç”Ÿåœ°ï¼š${currentResultData.birthplace}

ã€æ—¥æœŸä¿¡æ¯ã€‘
å…¬å†æ—¥æœŸï¼š${currentResultData.solarDate}
å†œå†æ—¥æœŸï¼š${currentResultData.lunarDate}

ã€å››æŸ±å…«å­—ã€‘
${currentResultData.siZhu}

ã€å¤§è¿ã€‘
${currentResultData.daYun}

ã€èµ·è¿æ—¶é—´ã€‘
${currentResultData.qiYunDate}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `.trim();

            try {
                await navigator.clipboard.writeText(formattedText);
                
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ å·²å¤åˆ¶';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                showError('å¤åˆ¶å¤±è´¥: ' + err.message);
            }
        });

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
        }

        // è¿åŠ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        fortuneBtn.addEventListener('click', async () => {
            if (!currentBaziRequest) {
                showError('è¯·å…ˆè®¡ç®—å…«å­—');
                return;
            }

            // å¦‚æœå·²ç»æœ‰æ•°æ®ä¸”å›¾è¡¨å®¹å™¨å·²æ˜¾ç¤º,ç›´æ¥æ»šåŠ¨åˆ°å›¾è¡¨ä½ç½®
            if (fortuneData && fortuneChartContainer.classList.contains('show')) {
                fortuneChartContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            loading.classList.add('show');
            error.classList.remove('show');
            fortuneBtn.disabled = true;

            try {
                const response = await fetch('/api/bazi/fortune', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentBaziRequest),
                });

                const data = await response.json();

                if (data.success) {
                    fortuneData = data.data;
                    renderFortuneChart(fortuneData);
                    fortuneChartContainer.classList.add('show');
                    
                    // æ»šåŠ¨åˆ°å›¾è¡¨ä½ç½®
                    setTimeout(() => {
                        fortuneChartContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    showError(data.error || 'è¿åŠ¿è®¡ç®—å¤±è´¥');
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            } finally {
                loading.classList.remove('show');
                fortuneBtn.disabled = false;
            }
        });

        // æ¸²æŸ“è¿åŠ¿Kçº¿å›¾
        function renderFortuneChart(data) {
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨,å…ˆé”€æ¯
            if (fortuneChart) {
                fortuneChart.dispose();
                fortuneChart = null;
            }

            // è·å–æ˜¾ç¤ºèŒƒå›´
            const range = parseInt(chartRange.value);
            const displayData = data.slice(0, range);

            // å‡†å¤‡æ•°æ®
            const years = displayData.map(item => item.year);
            const klineData = displayData.map(item => [item.open, item.close, item.low, item.high]);
            const scoreData = displayData.map(item => item.score);
            
            // è®¡ç®—å¹³å‡åˆ†
            const averageScore = scoreData.reduce((sum, score) => sum + score, 0) / scoreData.length;

            // åˆå§‹åŒ–å›¾è¡¨ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ç¡®ä¿DOMå·²å‡†å¤‡å¥½ï¼‰
            setTimeout(() => {
                const chartDom = document.getElementById('fortuneChart');
                fortuneChart = echarts.init(chartDom, null, {
                    renderer: 'canvas',
                    useDirtyRect: false
                });

                // é…ç½®é¡¹ - æ›´ç°ä»£çš„æ ·å¼
                const option = {
                    animation: true,
                    animationDuration: 800,
                    animationEasing: 'cubicOut',
                    backgroundColor: '#fafafa',
                    title: {
                        text: 'å‘½ç†è¿åŠ¿Kçº¿èµ°åŠ¿å›¾',
                        subtext: `å‡ºç”Ÿå¹´ä»½: ${currentBaziRequest.year}å¹´ | æ˜¾ç¤ºèŒƒå›´: ${range} å¹´`,
                        left: 'center',
                        top: 15,
                        textStyle: {
                            color: '#2c3e50',
                            fontSize: 20,
                            fontWeight: '600'
                        },
                        subtextStyle: {
                            color: '#7f8c8d',
                            fontSize: 13
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            crossStyle: {
                                color: '#667eea'
                            },
                            lineStyle: {
                                color: '#667eea',
                                type: 'dashed'
                            }
                        },
                        backgroundColor: 'rgba(50, 50, 50, 0.95)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        textStyle: {
                            color: '#fff',
                            fontSize: 13
                        },
                        padding: 15,
                        formatter: function(params) {
                            if (!params || params.length === 0) return '';
                            
                            // è·å–dataIndexï¼Œç¡®ä¿ä»æ­£ç¡®çš„æ•°æ®æºè¯»å–
                            const dataIndex = params[0].dataIndex;
                            const itemData = displayData[dataIndex];
                            
                            const year = itemData.year;
                            const age = year - currentBaziRequest.year;
                            
                            let result = `<div style="padding: 5px;">
                                <div style="font-weight: bold; margin-bottom: 10px; font-size: 15px; color: #fff; border-bottom: 2px solid #667eea; padding-bottom: 5px;">
                                    ğŸ“… ${year}å¹´ (${age}å²)
                                </div>`;
                            
                            // æ˜¾ç¤ºKçº¿æ•°æ®
                            const open = itemData.open;
                            const close = itemData.close;
                            const high = itemData.high;
                            const low = itemData.low;
                            const score = itemData.score;
                            
                            const isRise = close >= open;
                            const color = isRise ? '#ff4757' : '#2ed573';
                            const icon = isRise ? 'ğŸ“ˆ' : 'ğŸ“‰';
                            const trend = isRise ? 'ä¸Šæ¶¨' : 'ä¸‹é™';
                            
                            result += `
                                <div style="margin: 8px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                                    <div style="color: ${color}; font-weight: bold; margin-bottom: 5px;">
                                        ${icon} è¿åŠ¿${trend}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                                        <span>å¹´åˆ:</span><span style="color: #ffd93d;">${open.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                                        <span>å¹´æœ«:</span><span style="color: #ffd93d;">${close.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                                        <span>æœ€é«˜:</span><span style="color: #ff6b81;">${high.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                                        <span>æœ€ä½:</span><span style="color: #70a1ff;">${low.toFixed(2)}</span>
                                    </div>
                                </div>`;
                            
                            // æ˜¾ç¤ºç»¼åˆè¯„åˆ†
                            let level = 'å¹³ç¨³';
                            let levelColor = '#ffd93d';
                            if (score >= 70) {
                                level = 'å¤§å‰';
                                levelColor = '#2ed573';
                            } else if (score >= 60) {
                                level = 'è¾ƒå‰';
                                levelColor = '#7bed9f';
                            } else if (score >= 50) {
                                level = 'å¹³ç¨³';
                                levelColor = '#ffd93d';
                            } else if (score >= 40) {
                                level = 'è¾ƒå·®';
                                levelColor = '#ff6348';
                            } else {
                                level = 'ä½è°·';
                                levelColor = '#ff4757';
                            }
                            
                            result += `
                                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #667eea;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>â­ ç»¼åˆè¯„åˆ†:</span>
                                        <span style="color: ${levelColor}; font-weight: bold; font-size: 16px;">${score.toFixed(2)}</span>
                                    </div>
                                    <div style="text-align: right; margin-top: 3px; color: ${levelColor};">
                                        ${level}
                                    </div>
                                </div>`;
                            
                            result += `</div>`;
                            return result;
                        }
                    },
                    legend: {
                        data: ['è¿åŠ¿Kçº¿', 'ç»¼åˆè¯„åˆ†'],
                        top: 60,
                        textStyle: {
                            color: '#34495e',
                            fontSize: 13
                        },
                        itemGap: 20
                    },
                    grid: {
                        left: '50',
                        right: '50',
                        bottom: '80',
                        top: 120,
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: years,
                        boundaryGap: true,
                        axisLine: {
                            lineStyle: {
                                color: '#95a5a6',
                                width: 2
                            }
                        },
                        axisTick: {
                            show: true,
                            lineStyle: {
                                color: '#bdc3c7'
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#ecf0f1',
                                type: 'dashed'
                            }
                        },
                        axisLabel: {
                            interval: 'auto',
                            rotate: range > 50 ? 45 : 0,
                            color: '#34495e',
                            fontSize: 11,
                            formatter: function(value) {
                                return value;
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        min: 0,
                        max: 100,
                        interval: 10,
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#95a5a6',
                                width: 2
                            }
                        },
                        axisTick: {
                            show: true,
                            lineStyle: {
                                color: '#bdc3c7'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ecf0f1',
                                type: 'dashed'
                            }
                        },
                        axisLabel: {
                            color: '#34495e',
                            fontSize: 12,
                            formatter: '{value}'
                        },
                        splitArea: {
                            show: true,
                            areaStyle: {
                                color: ['rgba(255, 255, 255, 0.3)', 'rgba(240, 240, 240, 0.3)']
                            }
                        }
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100,
                            zoomOnMouseWheel: true,
                            moveOnMouseMove: true,
                            moveOnMouseWheel: false
                        },
                        {
                            show: true,
                            type: 'slider',
                            bottom: 10,
                            start: 0,
                            end: 100,
                            height: 30,
                            borderColor: '#667eea',
                            fillerColor: 'rgba(102, 126, 234, 0.2)',
                            handleStyle: {
                                color: '#667eea',
                                borderColor: '#667eea'
                            },
                            textStyle: {
                                color: '#34495e'
                            }
                        }
                    ],
                    series: [
                        {
                            name: 'è¿åŠ¿Kçº¿',
                            type: 'candlestick',
                            data: klineData,
                            barWidth: range > 50 ? '60%' : '70%',
                            itemStyle: {
                                color: '#ff4757',
                                color0: '#2ed573',
                                borderColor: '#ff4757',
                                borderColor0: '#2ed573',
                                borderWidth: 1.5
                            },
                            emphasis: {
                                itemStyle: {
                                    borderWidth: 2.5,
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(0, 0, 0, 0.3)',
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5
                                }
                            },
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                animation: false,
                                label: {
                                    show: true,
                                    position: 'insideEndTop',
                                    formatter: `å¹³å‡çº¿ (${averageScore.toFixed(2)}åˆ†)`,
                                    color: '#2c3e50',
                                    fontSize: 13,
                                    fontWeight: 'bold',
                                    backgroundColor: 'rgba(236, 240, 241, 0.9)',
                                    padding: [6, 10],
                                    borderRadius: 4,
                                    borderColor: '#95a5a6',
                                    borderWidth: 1
                                },
                                lineStyle: {
                                    color: '#7f8c8d',
                                    width: 2.5,
                                    type: 'dashed',
                                    dashOffset: 5
                                },
                                emphasis: {
                                    disabled: true
                                },
                                data: [{
                                    yAxis: averageScore,
                                    name: 'å¹³å‡çº¿'
                                }],
                                z: 100
                            }
                        },
                        {
                            name: 'ç»¼åˆè¯„åˆ†',
                            type: 'line',
                            data: scoreData,
                            smooth: true,
                            smoothMonotone: 'x',
                            lineStyle: {
                                color: '#667eea',
                                width: 3,
                                shadowColor: 'rgba(102, 126, 234, 0.3)',
                                shadowBlur: 10
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(102, 126, 234, 0.4)' },
                                        { offset: 1, color: 'rgba(102, 126, 234, 0.05)' }
                                    ]
                                }
                            },
                            itemStyle: {
                                color: '#667eea',
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            showSymbol: false,
                            symbolSize: 6,
                            emphasis: {
                                focus: 'series',
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(102, 126, 234, 0.5)'
                                }
                            },
                            z: 10
                        }
                    ]
                };

                // è®¾ç½®é…ç½®é¡¹
                fortuneChart.setOption(option, true);

                // å“åº”å¼
                const resizeHandler = () => {
                    if (fortuneChart) {
                        fortuneChart.resize();
                    }
                };
                
                window.removeEventListener('resize', resizeHandler);
                window.addEventListener('resize', resizeHandler);
            }, 100);
        }

        // å›¾è¡¨èŒƒå›´æ”¹å˜äº‹ä»¶
        chartRange.addEventListener('change', () => {
            if (fortuneData) {
                renderFortuneChart(fortuneData);
            }
        });

        // åˆ·æ–°å›¾è¡¨æŒ‰é’®
        refreshChart.addEventListener('click', () => {
            if (fortuneData) {
                renderFortuneChart(fortuneData);
            }
        });

        // è¡¨å•é‡ç½®æ—¶æ¸…ç©ºè¿åŠ¿æ•°æ®
        form.addEventListener('reset', () => {
            currentResultData = null;
            currentBaziRequest = null;
            fortuneData = null;
            result.classList.remove('show');
            fortuneChartContainer.classList.remove('show');
            error.classList.remove('show');
            fortuneBtn.disabled = true;
            
            if (fortuneChart) {
                fortuneChart.dispose();
                fortuneChart = null;
            }
        });
    </script>
</body>
</html>



