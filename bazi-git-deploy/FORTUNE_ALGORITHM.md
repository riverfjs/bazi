# 百年运势K线计算算法说明

## 算法概述

本系统基于传统八字命理学，综合考虑**命盘、大运、流年**三者关系，计算个人百年运势走向。

## 核心计算逻辑

### 1. 命盘基础分计算 (calculateBaseScore)

**目的**: 判断命格强弱，确定运势基准线

**计算要素**:
- 日主五行力量（日干代表命主本身）
- 印星力量（生日主的五行，代表贵人、学识）
- 身旺身弱判断：
  - 身旺（日主+印星 > 40%）: 基础分55，需要制衡
  - 身弱（日主+印星 < 25%）: 基础分45，需要扶助
  - 中和: 基础分50

### 2. 八字五行力量分布 (calculateBaziPower)

**四柱权重分配**:
```
天干力量:
- 年干: 10分 (祖辈、早年)
- 月干: 12分 (父母、青年，权重最大)
- 日干: 15分 (自身，权重最大)
- 时干: 10分 (子女、晚年)

地支力量:
- 年支: 8分
- 月支: 10分 (月令，决定旺衰)
- 日支: 8分 (配偶宫)
- 时支: 8分 (子女宫)
```

### 3. 年度运势综合计算 (calculateYearFortuneAdvanced)

#### 权重分配:

| 因素 | 权重 | 说明 |
|-----|------|-----|
| 大运对日主影响 | 40% | 十年大运主导整体运势 |
| 流年对日主影响 | 30% | 当年太岁影响 |
| 大运与流年互动 | 15% | 合化、刑冲关系 |
| 流年与命盘互动 | 10% | 与日柱的关系 |
| 其他因素 | 5% | 年龄、换运等 |

#### 具体计算:

**A. 大运影响 (40%)**
```
- 大运天干对日主: 生克关系评分 × 30%
- 大运地支对日主: 生克关系评分 × 25%
- 未起运期影响减半
- 大运前5年天干主事，后5年地支主事
```

**B. 流年影响 (30%)**
```
- 流年天干对日主: 生克关系评分 × 20%
- 流年地支对日主: 生克关系评分 × 15%
```

**C. 大运流年互动 (15%)**
```
吉神:
+ 天干相合: +8分 (甲己合土、乙庚合金、丙辛合水、丁壬合木、戊癸合火)
+ 地支相合: +6分 (子丑合、寅亥合、卯戌合、辰酉合、巳申合、午未合)

凶神:
- 天干相冲: -8分 (阴阳同性相克)
- 地支相冲: -10分 (子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲)
```

**D. 流年与命盘互动 (10%)**
```
- 流年冲日支: -7分 (影响身体、事业)
- 流年合日支: +5分 (贵人相助)
```

**E. 特殊情况处理**
```
- 换大运之年: -5分 (交接期运势波动)
- 未起运阶段: 以月柱代替大运
```

### 4. 五行生克评分 (calculateShengKeScore)

```
相生关系:
+ 被生（我受生）: +12分 ★★★ (如水命遇金年，金生水)
+ 生他人（我生他）: +5分 ★ (泄气，如水命遇木年，水生木)
+ 同类比和: +6分 ★★ (如水命遇水年，帮身)

相克关系:
+ 克他人（我克他）: +8分 ★★ (财星，如水命遇火年，水克火)
- 被克（他克我）: -10分 ✗✗✗ (官杀，如水命遇土年，土克水)
```

### 5. K线生成逻辑

**目标**: 生成平滑、连续、符合命理规律的K线

```
年初运势(Open):
= 上年收盘 × 30% + 本年运势 × 70%
(平滑过渡，避免断崖式变化)

年末运势(Close):
= 本年运势 × 70% + 下年预估 × 30%
(向下一年过渡)

年内最高(High):
= 年度运势 + 吉神加成
(春夏秋冬最旺月份)

年内最低(Low):
= 年度运势 + 凶神减弱
(五行最弱月份)
```

### 6. 年龄生命周期影响 (calculateAgeEffect)

```
0-10岁: +5分 (童年，纯真)
10-20岁: +3分 (青少年，成长)
20-30岁: +8分 (青年，上升期) ★
30-40岁: +10分 (壮年，人生高峰) ★★★
40-50岁: +6分 (中年，稳定期)
50-60岁: +4分 (中老年，下降期)
60-70岁: +2分 (老年，平稳期)
70岁+: 0分 (晚年，淡泊期)
```

## 实例分析

以您提供的八字为例：
```
出生: 1922年10月01日 12:30
四柱: 壬戌 己酉 壬寅 丙午
起运: 1925年 (3岁起运)
大运: 庚戌 辛亥 壬子 癸丑 甲寅 乙卯 丙辰 丁巳 戊午 己未 庚申 辛酉
```

**命盘分析**:
- 日主: 壬水（水命）
- 月令: 己酉（秋金旺，金生水，身旺）
- 五行力量: 水旺、金次、火土木弱
- 判断: 身旺喜泄，喜木火，忌水金

**运势走向**:
1. **0-3岁（未起运）**: 以月柱己酉为用，基础运势中等
2. **3-13岁（庚戌运）**: 庚金生壬水，身更旺，运势一般
3. **13-23岁（辛亥运）**: 辛金、亥水助身，过旺，运势下降
4. **23-33岁（壬子运）**: 壬子皆水，比劫过重，运势低谷 ✗
5. **33-43岁（癸丑运）**: 癸水丑土，略有改善
6. **43-53岁（甲寅运）**: 甲木寅木泄水，大吉运 ★★★
7. **53-63岁（乙卯运）**: 乙木卯木泄水生火，继续吉运 ★★
8. **63-73岁（丙辰运）**: 丙火制水，运势中上
9. **73-83岁（丁巳运）**: 丁火巳火，运势平稳
10. **83-93岁（戊午运）**: 戊土午火，晚年安稳

**K线特点**:
- 23-33岁会显示明显的低谷（绿色阴线多）
- 43-63岁会显示明显的高峰（红色阳线多）
- 整体呈现波浪式上升后下降的生命曲线

## 算法优势

1. **真实使用大运数据**: 不再是简单的索引计算，而是真正获取每步大运的天干地支
2. **考虑起运年龄**: 正确处理未起运阶段的运势
3. **K线平滑连续**: 通过前后年份的关联，避免剧烈跳变
4. **符合命理规律**: 充分考虑天干地支的合化刑冲关系
5. **多维度评估**: 综合命盘、大运、流年、年龄等多个因素

## 注意事项

- 运势评分范围: 15-95分（避免极端值）
- 算法仅供参考娱乐，不可过度迷信
- 真实运势受个人努力、环境、机遇等多种因素影响
