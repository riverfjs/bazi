# 神煞功能实现文档

## 概述

为BaziGo八字库添加了完整的神煞(ShenSha)计算功能，并将神煞信息整合到百年运势K线算法中，使运势计算更加准确和全面。

## 实现的功能

### 1. 神煞模块 (shensha.go)

新增了`TShenSha`结构体和完整的神煞计算功能，支持以下神煞：

#### 吉神
- **天乙贵人** (权重: +12分) - 最重要的吉神，遇难呈祥
  - 口诀：甲戊庚牛羊，乙己鼠猴乡，丙丁猪鸡位，壬癸兔蛇藏，六辛逢马虎
- **天德贵人** (权重: +10分) - 德性高尚，贵人相助
- **月德贵人** (权重: +9分) - 品德高尚，一生安稳
- **文昌贵人** (权重: +8分) - 聪明好学，利于考试升学
- **禄神** (权重: +8分) - 有福禄，衣食无忧
- **将星** (权重: +6分) - 有威望，适合从政或管理
- **华盖** (权重: +4分) - 艺术天赋，但也主孤独
- **驿马** (权重: +5分) - 走动频繁，多变化

#### 凶神
- **羊刃** (权重: -8分) - 性格刚烈，易有血光之灾
- **孤辰** (权重: -6分) - 性格孤独
- **寡宿** (权重: -6分) - 婚姻不顺
- **劫煞** (权重: -7分) - 破财，意外之灾
- **亡神** (权重: -7分) - 疾病，意外
- **天罗地网** (权重: -9分) - 困顿受阻
- **桃花** (权重: +3分) - 异性缘佳，但也主风流

### 2. 四柱神煞 (sizhu.go)

在`TSiZhu.init()`方法中添加了神煞计算：
```go
// 生成神煞数据(在所有柱子生成之后)
dayGan := m.pDayZhu.Gan()
dayZhi := m.pDayZhu.Zhi()
m.pYearZhu.genShenSha(dayGan, dayZhi)
m.pMonthZhu.genShenSha(dayGan, dayZhi)
m.pDayZhu.genShenSha(dayGan, dayZhi)
m.pHourZhu.genShenSha(dayGan, dayZhi)
```

### 3. 大运神煞 (dayun.go)

在`TDaYun.init()`方法中为每步大运计算神煞：
```go
// 为每步大运计算神煞
m.zhuList[i].genShenSha(dayGan, dayZhi)
```

### 4. 流年神煞 (main.go)

在运势计算中动态计算每年的流年神煞：
```go
// 计算流年神煞
liuNianShenSha := bazi.CalcShenSha(dayGan, dayZhi, liuNianGan, liuNianZhi, "流年")
```

## K线运势算法增强

### 权重重新分配

将原有的权重进行了调整，为神煞留出空间：

| 因素 | 原权重 | 新权重 | 说明 |
|-----|-------|-------|-----|
| 大运对日主影响 | 40% | 35% | 天干25% + 地支20% |
| 流年对日主影响 | 30% | 25% | 天干15% + 地支12% |
| 大运流年互动 | 15% | 12% | 合化刑冲 |
| 流年与命盘互动 | 10% | 8% | 与日柱关系 |
| **大运神煞影响** | - | **10%** | 新增 |
| **流年神煞影响** | - | **10%** | 新增 |
| 五行平衡度 | 10% | 5% | 调整 |
| 其他因素 | 5% | 5% | 年龄、换运等 |

### 神煞评分逻辑 (calculateShenShaScore)

```go
func calculateShenShaScore(shenSha *bazi.TShenSha) float64 {
    // 1. 基础评分：累加各神煞权重
    // 2. 特殊组合加成：
    //    - 天乙贵人 + 天德贵人 = 额外+5分
    //    - 吉神多于凶神 = 额外加成
    // 3. 评分范围：-20 到 +30
}
```

### 实例说明

假设某年大运和流年的神煞情况：

**大运神煞**: 天乙贵人(+12)、文昌贵人(+8)  
**流年神煞**: 禄神(+8)、羊刃(-8)

计算过程：
1. 大运神煞得分 = (12 + 8) = 20分
2. 大运神煞影响 = 20 × 0.8 = +16分 (持续10年，权重0.8)
3. 流年神煞得分 = (8 - 8) = 0分
4. 流年神煞影响 = 0 × 1.2 = 0分 (当年，权重1.2)
5. 总神煞加成 = +16分

## API使用方法

### 获取四柱神煞

```go
pBazi := bazi.GetBazi(1995, 6, 16, 19, 7, 0, 0)

// 获取年柱神煞
yearShenSha := pBazi.SiZhu().YearZhu().ShenSha()
fmt.Println("年柱神煞:", yearShenSha.String())
fmt.Println("吉神数量:", yearShenSha.GetJiShenCount())
fmt.Println("凶神数量:", yearShenSha.GetXiongShenCount())

// 获取其他柱神煞
monthShenSha := pBazi.SiZhu().MonthZhu().ShenSha()
dayShenSha := pBazi.SiZhu().DayZhu().ShenSha()
hourShenSha := pBazi.SiZhu().HourZhu().ShenSha()
```

### 获取大运神煞

```go
daYun := pBazi.DaYun()

// 获取第一步大运(0-9岁)的神煞
dayunShenSha := daYun.Zhu(0).ShenSha()
fmt.Println("第一步大运神煞:", dayunShenSha.String())
```

### 计算流年神煞

```go
dayGan := pBazi.SiZhu().DayZhu().Gan()
dayZhi := pBazi.SiZhu().DayZhu().Zhi()

// 计算2024年的流年神煞
liuNianGan := bazi.GetGanByYear(2024)
liuNianZhi := bazi.GetZhiByYear(2024)
liuNianShenSha := bazi.CalcShenSha(dayGan, dayZhi, liuNianGan, liuNianZhi, "流年")

fmt.Println("2024年流年神煞:", liuNianShenSha.String())
```

## 运势K线的改进效果

### 改进前
- 仅基于五行生克和干支合冲
- 运势波动较大，不够平滑
- 缺少传统命理中的神煞因素

### 改进后
- ✅ 整合了14种主要神煞
- ✅ 神煞权重占20%(大运10% + 流年10%)
- ✅ 运势评分更加全面和准确
- ✅ K线走势更符合传统命理规律

### 实际案例对比

**例：日主为甲木，某年流年为庚申**

**旧算法**:
- 流年庚金克甲木 → 得分-10
- 总分约: 40-50分 (低谷)

**新算法**:
- 流年庚金克甲木 → 得分-7 (权重降低)
- 流年神煞：天乙贵人(+12)、文昌贵人(+8)
- 神煞加成：20 × 1.2 = +24分
- 总分约: 60-70分 (平稳偏吉)

**解释**: 虽然五行相克，但流年带吉神，有贵人相助，逢凶化吉。

## 技术实现细节

### 神煞计算方法

1. **以日主为中心**: 所有神煞都以日干和日支为基准计算
2. **查表法**: 使用传统口诀建立映射表
3. **去重处理**: 同一神煞不重复计算
4. **分类统计**: 区分吉神和凶神

### 性能优化

- 神煞在四柱和大运初始化时一次性计算
- 流年神煞动态计算，避免内存浪费
- 使用map结构快速查找神煞权重

## 文件清单

### 新增文件
- `lib/BaziGo/shensha.go` - 神煞计算核心模块(约700行)

### 修改文件
- `lib/BaziGo/zhu.go` - TZhu结构添加神煞字段和方法
- `lib/BaziGo/sizhu.go` - 四柱初始化时计算神煞
- `lib/BaziGo/dayun.go` - 大运初始化时计算神煞
- `main.go` - K线算法整合神煞影响
- `go.mod` - 添加本地替换指令

## 测试建议

### 测试案例1: 吉神年份
```
出生: 1990年1月1日12时
流年: 2030年 (庚戌年)
预期: 如果流年有天乙贵人等吉神，运势应显著提升
```

### 测试案例2: 凶神年份
```
出生: 1990年1月1日12时
流年: 2035年 (乙卯年)
预期: 如果流年有羊刃等凶神，运势应有所下降
```

### 测试案例3: 神煞组合
```
出生: 1990年1月1日12时
检查: 四柱中的神煞组合
验证: 吉神数量和凶神数量是否正确统计
```

## 注意事项

1. **神煞不是唯一因素**: 神煞只占运势评分的20%，五行生克仍是主导
2. **传统口诀为准**: 所有神煞计算都遵循传统命理口诀
3. **综合判断**: 需要结合整体命局，不可单看神煞
4. **持续优化**: 后续可根据实际反馈调整神煞权重

## 未来扩展

### 可添加的神煞
- 红鸾、天喜(婚姻)
- 天医、天厨(健康饮食)
- 金舆、禄马(财富地位)
- 元辰、灾煞(凶灾)

### 可改进方向
- 神煞之间的相互作用(如吉神制凶神)
- 不同年龄段神煞的权重调整
- 根据十神强弱动态调整神煞影响力

## 总结

通过添加神煞功能，使得八字运势分析更加符合传统命理学的全面性和准确性。神煞作为传统命理的重要组成部分，与五行生克、干支合冲共同构成了完整的命理分析体系。

在K线运势图中，神煞的影响使得运势评分更加细腻，能够解释一些仅靠五行无法解释的运势波动，提升了系统的专业性和实用性。

